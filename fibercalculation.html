<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Desain Jaringan FO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* CSS untuk membuat diagram pohon */
        .tree ul {
            position: relative;
            padding-left: 20px;
            margin-left: 10px;
            list-style-type: none;
        }

        .tree li {
            position: relative;
            padding-top: 10px;
        }

        /* Garis vertikal */
        .tree ul::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            border-left: 2px solid #cbd5e1; /* gray-300 */
        }

        .tree li::before {
            content: '';
            position: absolute;
            top: 28px; /* Sesuaikan agar pas dengan tengah node */
            left: -20px;
            width: 20px;
            height: 2px;
            background-color: #cbd5e1; /* gray-300 */
        }

        .tree li:last-child > ul::before {
            bottom: auto;
            height: 28px; /* Pas dengan ::before li */
        }

        .node {
            background-color: white;
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 8px;
            padding: 12px;
            display: inline-block;
            min-width: 280px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .node-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-controls {
            margin-top: 12px;
            border-top: 1px dashed #e2e8f0;
            padding-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .node-controls select,
        .node-controls input,
        .node-controls button {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            font-size: 14px;
        }
        
        .node-controls button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 500;
            cursor: pointer;
        }
        .node-controls button:hover {
            background-color: #2563eb; /* blue-600 */
        }
        
        .node-controls .custom-loss-input {
            width: 80px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Kalkulator & Desainer Jaringan Fiber Optik (PON)</h1>
        <p class="mt-2 text-gray-600">Mulai dari OLT, tambahkan splitter (ODC/ODP) untuk merancang jaringan Anda dan menghitung redaman (power budget).</p>
    
        <!-- Kontrol Awal -->
        <div class="mt-6 flex flex-wrap gap-4 items-center border-b pb-6 mb-6 border-gray-200">
            <div>
                <label for="initial-power" class="block text-sm font-medium text-gray-700">Power Awal OLT (dBm)</label>
                <input type="number" id="initial-power" value="0.82" step="0.01" class="mt-1 w-32 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="start-btn" class="self-end px-5 py-2 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Mulai / Reset Desain
            </button>
        </div>
    
        <!-- Area Diagram -->
        <div id="diagram-container" class="overflow-x-auto p-2">
            <p class="text-gray-500">Klik "Mulai / Reset Desain" untuk membuat node OLT.</p>
        </div>
    </div>

    <script>
        // Data loss untuk setiap splitter (nilai praktis, termasuk insertion loss)
        // Format: 'Nama': [loss_A, loss_B, ...]
        const SPLITTER_LOSS_DB = {
            '1:2': [3.8],
            '1:4': [7.5],
            '1:8': [11.0],
            '1:16': [14.2],
            '1:32': [17.5],
            '1:64': [21.0],
            '90/10': [10.5, 0.9], // [loss port 90%, loss port 10%]
            '80/20': [7.4, 1.4], // [loss port 80%, loss port 20%]
            '70/30': [5.7, 2.0], // [loss port 70%, loss port 30%]
            '60/40': [4.4, 2.6],
            '50/50': [3.4, 3.4],
            'custom': [] // Akan diisi oleh user
        };

        let networkData = {}; // Objek untuk menyimpan data pohon jaringan
        let nodeIdCounter = 0;

        const startBtn = document.getElementById('start-btn');
        const initialPowerInput = document.getElementById('initial-power');
        const diagramContainer = document.getElementById('diagram-container');

        startBtn.addEventListener('click', startApp);

        function startApp() {
            nodeIdCounter = 0;
            const initialPower = parseFloat(initialPowerInput.value) || 0;
            networkData = {
                id: nodeIdCounter,
                name: 'OLT',
                power: initialPower,
                splitType: 'Start',
                children: []
            };
            renderNetwork();
        }

        // Fungsi untuk me-render seluruh jaringan dari data
        function renderNetwork() {
            diagramContainer.innerHTML = '';
            const treeRoot = document.createElement('ul');
            treeRoot.className = 'tree';
            
            const nodeElement = createNodeHtml(networkData);
            treeRoot.appendChild(nodeElement);
            diagramContainer.appendChild(treeRoot);
            
            // Tambahkan event listener untuk semua elemen kontrol yang baru dibuat
            addEventListeners();
        }

        // Fungsi rekursif untuk membuat elemen HTML dari node data
        function createNodeHtml(node) {
            const li = document.createElement('li');
            
            const powerLevel = node.power.toFixed(2);
            let powerColorClass = 'text-green-600'; // Good
            if (powerLevel < -25) powerColorClass = 'text-yellow-600'; // Warning
            if (powerLevel < -28) powerColorClass = 'text-red-600'; // Bad
            
            let splitInfo = node.splitType === 'Start' ? 'Titik Awal' : `Dari ${node.splitType}`;

            li.innerHTML = `
                <div class="node" data-id="${node.id}">
                    <div class="node-content">
                        <div>
                            <span class="font-bold text-lg text-gray-800">${node.name}</span>
                            <span class="block text-sm text-gray-500">${splitInfo}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-xl ${powerColorClass}">${powerLevel} dBm</span>
                            <span class="block text-sm text-gray-500">Power</span>
                        </div>
                    </div>
                    
                    <div class="node-controls">
                        <input type="text" class="node-label-input" placeholder="Label (cth: ODP-01)" data-node-id="${node.id}">
                        <select class="splitter-select" data-node-id="${node.id}">
                            <option value="">Pilih Splitter</option>
                            ${Object.keys(SPLITTER_LOSS_DB).map(key => `<option value="${key}">${key}</option>`).join('')}
                        </select>
                        <input type="number" class="custom-loss-input hidden" placeholder="Loss (dB)" data-node-id="${node.id}">
                        <button class="add-splitter-btn" data-node-id="${node.id}">+</button>
                    </div>
                </div>
            `;

            if (node.children && node.children.length > 0) {
                const ul = document.createElement('ul');
                node.children.forEach(childNode => {
                    ul.appendChild(createNodeHtml(childNode));
                });
                li.appendChild(ul);
            }
            
            return li;
        }

        // Fungsi untuk menambahkan event listener ke tombol dan select
        function addEventListeners() {
            // Event untuk tombol "Add Splitter"
            document.querySelectorAll('.add-splitter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const nodeId = button.dataset.nodeId;
                    addSplitter(nodeId);
                });
            });

            // Event untuk select splitter (menampilkan/menyembunyikan input custom loss)
            document.querySelectorAll('.splitter-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const nodeId = e.target.dataset.nodeId;
                    const customInput = document.querySelector(`.custom-loss-input[data-node-id="${nodeId}"]`);
                    if (e.target.value === 'custom') {
                        customInput.classList.remove('hidden');
                    } else {
                        customInput.classList.add('hidden');
                    }
                });
            });
        }
        
        // Fungsi untuk menambahkan splitter baru
        function addSplitter(parentId) {
            const parentNode = findNodeById(networkData, parseInt(parentId));
            if (!parentNode) return;

            const labelInput = document.querySelector(`.node-label-input[data-node-id="${parentId}"]`);
            const splitterSelect = document.querySelector(`.splitter-select[data-node-id="${parentId}"]`);
            const customLossInput = document.querySelector(`.custom-loss-input[data-node-id="${parentId}"]`);
            
            const splitType = splitterSelect.value;
            if (!splitType) {
                alert("Silakan pilih tipe splitter.");
                return;
            }

            let losses = [];
            let outputNames = [];

            if (splitType === 'custom') {
                const customLoss = parseFloat(customLossInput.value);
                if (isNaN(customLoss)) {
                    alert("Masukkan nilai loss (dB) untuk splitter custom.");
                    return;
                }
                losses = [customLoss];
                outputNames = ['Custom Port'];
            } else {
                losses = SPLITTER_LOSS_DB[splitType];
                // Buat nama port
                if (losses.length === 1) { // Splitter seimbang (1:N)
                    const N = parseInt(splitType.split(':')[1]);
                    for (let i = 1; i <= N; i++) {
                        outputNames.push(`Port ${i}`);
                    }
                    // Duplikasi loss untuk semua port
                    losses = Array(N).fill(losses[0]);
                } else { // Splitter tidak seimbang (e.g., 80/20)
                    const ratios = splitType.split('/');
                    outputNames = [`Port ${ratios[0]}%`, `Port ${ratios[1]}%`];
                }
            }

            const baseLabel = labelInput.value.trim() || 'Split';

            // Buat node anak baru
            for (let i = 0; i < losses.length; i++) {
                nodeIdCounter++;
                const newPower = parentNode.power - losses[i];
                const nodeName = losses.length > 1 ? `${baseLabel} (${outputNames[i]})` : baseLabel;
                
                const newNode = {
                    id: nodeIdCounter,
                    name: nodeName,
                    power: newPower,
                    splitType: `${splitType} (Loss: ${losses[i].toFixed(1)} dB)`,
                    children: []
                };
                parentNode.children.push(newNode);
            }
            
            // Render ulang seluruh jaringan
            renderNetwork();
        }

        // Fungsi helper untuk mencari node berdasarkan ID di pohon data
        function findNodeById(node, id) {
            if (node.id === id) {
                return node;
            }
            if (node.children) {
                for (const child of node.children) {
                    const found = findNodeById(child, id);
                    if (found) {
                        return found;
                    }
                }
            }
            return null;
        }

        // Mulai aplikasi saat halaman dimuat
        startApp();
    </script>
</body>
</html>
